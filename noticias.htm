<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Noticias y Contenido | EKUSFM</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" href="icon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
      :root {
        --bg: #070b16;
        --panel: rgba(16, 25, 54, 0.78);
        --text: #f7f8ff;
        --muted: #9da5c6;
        --accent: #65d6ff;
        --accent-strong: #2cb6ff;
        --border: rgba(255, 255, 255, 0.1);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        color: var(--text);
        font-family: "Inter", system-ui, sans-serif;
        background: radial-gradient(circle at 20% 0%, #162753 0, var(--bg) 40%);
        padding: 1rem 0 120px;
      }
      .container { width: min(1120px, 92vw); margin: 0 auto; }
      .topbar {
        display:flex; justify-content:space-between; align-items:center;
        border:1px solid var(--border); background:var(--panel); border-radius:16px;
        padding:.85rem 1rem; margin-bottom:1rem;
      }
      .brand { display:flex; align-items:center; gap:.8rem; font-weight:700; }
      .brand__mark { width:40px; height:40px; display:grid; place-items:center; border-radius:10px; background:linear-gradient(145deg, var(--accent), #8b5cf6); }
      .btn { border:1px solid var(--border); color:var(--text); text-decoration:none; padding:.55rem .9rem; border-radius:999px; }
      .hero { border:1px solid var(--border); background:var(--panel); border-radius:20px; padding:1.3rem; margin-bottom:1rem; }
      .hero h1 { margin:.3rem 0 .4rem; font-size: clamp(1.5rem,2.7vw,2.3rem); }
      .hero p { margin:0; color: var(--muted); }
      .section {
        border: 1px solid var(--border); background: var(--panel); border-radius:18px; padding: 1rem; margin-bottom: .9rem;
      }
      .section h2 { margin: .1rem 0 .8rem; }
      .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap:.75rem; }
      .card { border:1px solid var(--border); background:rgba(0,0,0,.16); border-radius:12px; padding:.85rem; }
      .news-image { width:100%; height:180px; object-fit:cover; border-radius:10px; margin-bottom:.55rem; }
      .meta { color:var(--muted); font-size:.85rem; margin-bottom:.45rem; }
      .news-content { color: var(--muted); white-space: pre-wrap; display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical; overflow:hidden; }
      .news-content.expanded { -webkit-line-clamp: initial; }
      .read-more-btn { margin-top:.55rem; border:none; background:linear-gradient(120deg,var(--accent),var(--accent-strong)); color:#fff; padding:.5rem .7rem; border-radius:10px; cursor:pointer; }
      .no-data-message { color:var(--muted); }
      .loader-spinner { border:3px solid #ffffff20; border-top-color: var(--accent); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; margin: .5rem auto; }
      @keyframes spin { to { transform: rotate(360deg);} }

      #mini-reproductor-footer {
        position: fixed; left: 0; right: 0; bottom: 0; width: 100%; z-index: 99999;
        display: flex; align-items: center; gap: 14px; padding: 14px 16px;
        background: #101936; border-top: 1px solid var(--border);
      }
      .mini-cover-img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; }
      .mini-play-btn { width:42px; height:42px; border:none; border-radius:50%; background:var(--accent); color:#0d1430; font-size:1.1rem; cursor:pointer; }
      .mini-info-and-volume { flex:1; min-width:0; }
      .mini-song-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .mini-artist-name { color: var(--muted); font-size: .9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .mini-volume-control-container { display:flex; align-items:center; gap:.4rem; margin-top:.3rem; }
      .mini-volume-control { width:100%; }
      .audio-loader { height:2px; width:100%; background:var(--accent); transform-origin:left; transform:scaleX(0); }
      .audio-loader.loading { animation: loading-pulse 1.3s infinite; }
      @keyframes loading-pulse { 50% { transform: scaleX(.85);} }
    </style>
  </head>
  <body>
    <main class="container">
      <header class="topbar">
        <div class="brand"><span class="brand__mark">EK</span> Noticias y contenido</div>
        <a href="index.htm" class="btn"><i class="fas fa-arrow-left"></i> Volver</a>
      </header>

      <section class="hero">
        <p>ACTUALIZADO DESDE FIREBASE</p>
        <h1>Cobertura completa de EKUSFM en formato renovado.</h1>
        <p>Noticias, Top 10, programas y funciones destacadas con carga dinámica.</p>
      </section>

      <section class="section">
        <h2>Últimas Noticias</h2>
        <div id="news-list"><div class="loader-spinner"></div></div>
      </section>

      <section class="section">
        <h2>Top 10 Canciones</h2>
        <div id="videos-list" class="grid"><div class="loader-spinner"></div></div>
      </section>

      <section class="section">
        <h2>Nuestros Programas</h2>
        <div id="programs-list" class="grid"><div class="loader-spinner"></div></div>
      </section>

      <section class="section">
        <h2>Funciones Destacadas</h2>
        <ul id="features-list"><div class="loader-spinner"></div></ul>
      </section>
    </main>

    <div id="mini-reproductor-footer">
      <img id="miniCoverImg" class="mini-cover-img" src="https://radioaventura-web.vercel.app/img/default.jpg" alt="Carátula" />
      <button id="playPauseMiniBtn" class="mini-play-btn" title="Play/Pause"><i id="miniPlayIcon" class="fa-solid fa-play"></i></button>
      <div class="mini-info-and-volume">
        <div id="miniSongTitle" class="mini-song-title">Cargando...</div>
        <div id="miniArtistName" class="mini-artist-name"></div>
        <div class="mini-volume-control-container">
          <i class="material-icons">volume_down</i>
          <input type="range" id="miniVolumeControl" class="mini-volume-control" min="0" max="1" step="0.01" value="1" title="Volumen" />
          <i class="material-icons">volume_up</i>
        </div>
        <div id="audioLoader" class="audio-loader"></div>
      </div>
      <audio id="audio-mini" preload="auto" crossorigin="anonymous"></audio>
    </div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBHlQ6WQauQLTbvp_iHbkWZ8Bhv3fntSpM",
        authDomain: "ekusfm-d1a9d.firebaseapp.com",
        databaseURL: "https://ekusfm-d1a9d-default-rtdb.firebaseio.com",
        projectId: "ekusfm-d1a9d",
        storageBucket: "ekusfm-d1a9d.appspot.com",
        messagingSenderId: "849619346647",
        appId: "1:849619346647:web:06559451c66950d9b03c92",
        measurementId: "G-X59DPNG6N4"
      };

      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      const newsList = document.getElementById("news-list");
      const videosList = document.getElementById("videos-list");
      const programsList = document.getElementById("programs-list");
      const featuresList = document.getElementById("features-list");

      const escapeHtml = (value = "") =>
        String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");

      function emptyMessage(target, message) {
        target.innerHTML = `<p class="no-data-message">${message}</p>`;
      }

      function attachReadMore(button) {
        button.addEventListener("click", () => {
          const content = button.previousElementSibling;
          content.classList.toggle("expanded");
          button.textContent = content.classList.contains("expanded") ? "Ver Menos" : "Ver Más";
        });
      }

      async function loadNews() {
        newsList.innerHTML = '<div class="loader-spinner"></div>';
        try {
          const snapshot = await database.ref("noticias").orderByChild("date").once("value");
          if (!snapshot.exists()) return emptyMessage(newsList, "No hay noticias disponibles en este momento.");

          const items = Object.entries(snapshot.val()).map(([id, value]) => ({ id, ...value }));
          items.sort((a, b) => Number(b.date || 0) - Number(a.date || 0));

          newsList.innerHTML = items
            .map((item) => {
              const date = item.date ? new Date(item.date).toLocaleDateString("es-MX", { year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit" }) : "Fecha no disponible";
              const imageHtml = item.imageUrl ? `<img class="news-image" src="${escapeHtml(item.imageUrl)}" alt="${escapeHtml(item.title || "Noticia")}" loading="lazy"/>` : "";
              return `
                <article class="card">
                  ${imageHtml}
                  <h3>${escapeHtml(item.title || "Sin título")}</h3>
                  <p class="meta">${date}</p>
                  <p class="news-content">${escapeHtml(item.content || "Sin contenido")}</p>
                  <button class="read-more-btn">Ver Más</button>
                </article>`;
            })
            .join("");

          newsList.querySelectorAll(".read-more-btn").forEach(attachReadMore);
        } catch {
          emptyMessage(newsList, "Error al cargar las noticias.");
        }
      }

      async function loadVideos() {
        videosList.innerHTML = '<div class="loader-spinner"></div>';
        try {
          const snapshot = await database.ref("videos").orderByChild("order").once("value");
          if (!snapshot.exists()) return emptyMessage(videosList, "No hay videos disponibles.");

          const items = Object.entries(snapshot.val()).map(([id, value]) => ({ id, ...value })).sort((a, b) => Number(a.order || 0) - Number(b.order || 0));
          videosList.innerHTML = items
            .map(
              (item) => `<article class="card">
                  <h3>${escapeHtml(item.title || "Video")}</h3>
                  <p class="meta">${escapeHtml(item.description || "Sin descripción")}</p>
                  <p><a class="btn" href="${escapeHtml(item.youtubeUrl || item.url || "#")}" target="_blank" rel="noopener">Ver video</a></p>
                </article>`
            )
            .join("");
        } catch {
          emptyMessage(videosList, "Error al cargar los videos.");
        }
      }

      async function loadPrograms() {
        programsList.innerHTML = '<div class="loader-spinner"></div>';
        try {
          const snapshot = await database.ref("programs").once("value");
          if (!snapshot.exists()) return emptyMessage(programsList, "No hay programas disponibles.");

          const items = Object.entries(snapshot.val()).map(([id, value]) => ({ id, ...value })).sort((a, b) => String(a.name || "").localeCompare(String(b.name || "")));
          programsList.innerHTML = items
            .map(
              (item) => `<article class="card"><h3>${escapeHtml(item.name || "Programa")}</h3><p class="meta"><span class="material-icons" style="font-size:14px;vertical-align:middle">schedule</span> ${escapeHtml(item.schedule || "Horario no disponible")}</p><p>${escapeHtml(item.description || "Sin descripción")}</p></article>`
            )
            .join("");
        } catch {
          emptyMessage(programsList, "Error al cargar los programas.");
        }
      }

      async function loadFeatures() {
        featuresList.innerHTML = '<div class="loader-spinner"></div>';
        try {
          const snapshot = await database.ref("features").orderByChild("order").once("value");
          if (!snapshot.exists()) return emptyMessage(featuresList, "No hay funciones destacadas disponibles.");

          const items = Object.entries(snapshot.val()).map(([id, value]) => ({ id, ...value })).sort((a, b) => Number(a.order || 0) - Number(b.order || 0));
          featuresList.innerHTML = items
            .map((item) => `<li class="card" style="list-style:none;margin-bottom:.55rem;"><span class="material-icons" style="vertical-align:middle">${escapeHtml(item.icon || "star")}</span> <strong>${escapeHtml(item.title || "Función")}</strong>: ${escapeHtml(item.description || "Sin descripción")}</li>`)
            .join("");
        } catch {
          emptyMessage(featuresList, "Error al cargar las funciones destacadas.");
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await Promise.all([loadNews(), loadVideos(), loadPrograms(), loadFeatures()]);
      });

      (function bootstrapMiniPlayer() {
        const config = {
          radioName: "EKUSFM",
          streamURL: "https://stream.zeno.fm/7mk2bzwy5x8uv",
          zenoId: "7mk2bzwy5x8uv",
          fallbackCover: "https://radioaventura-web.vercel.app/img/default.jpg"
        };

        const audio = document.getElementById("audio-mini");
        const playBtn = document.getElementById("playPauseMiniBtn");
        const playIcon = document.getElementById("miniPlayIcon");
        const songTitle = document.getElementById("miniSongTitle");
        const artistName = document.getElementById("miniArtistName");
        const coverImg = document.getElementById("miniCoverImg");
        const volumeSlider = document.getElementById("miniVolumeControl");
        const loader = document.getElementById("audioLoader");

        audio.src = config.streamURL;
        audio.volume = volumeSlider.valueAsNumber || 1;

        playBtn.addEventListener("click", async () => {
          try {
            if (audio.paused) await audio.play();
            else audio.pause();
          } catch {
            songTitle.textContent = "No se pudo iniciar el audio";
          }
        });

        audio.addEventListener("play", () => {
          playIcon.classList.replace("fa-play", "fa-pause");
          loader.classList.add("loading");
        });
        audio.addEventListener("pause", () => {
          playIcon.classList.replace("fa-pause", "fa-play");
          loader.classList.remove("loading");
        });
        volumeSlider.addEventListener("input", () => {
          audio.volume = volumeSlider.valueAsNumber;
        });

        async function updateMetadata() {
          try {
            const response = await fetch(`https://zenoplay.zenomedia.com/api/zenofm/nowplaying/${config.zenoId}?_=${Date.now()}`);
            if (!response.ok) throw new Error("metadata error");
            const payload = await response.json();
            const currentSong = payload?.title || config.radioName;
            const parts = currentSong.split(" - ");
            const artist = parts[0]?.trim() || config.radioName;
            const title = parts[1]?.trim() || currentSong;
            songTitle.textContent = title;
            artistName.textContent = artist;

            const coverRes = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(`${artist} ${title}`)}&media=music&limit=1`);
            if (coverRes.ok) {
              const coverData = await coverRes.json();
              coverImg.src = coverData.results?.[0]?.artworkUrl100?.replace("100x100bb", "600x600bb") || config.fallbackCover;
            } else {
              coverImg.src = config.fallbackCover;
            }
          } catch {
            songTitle.textContent = config.radioName;
            artistName.textContent = "En Vivo";
            coverImg.src = config.fallbackCover;
          }
        }

        updateMetadata();
        setInterval(updateMetadata, 12000);
      })();
    </script>
  </body>
</html>
